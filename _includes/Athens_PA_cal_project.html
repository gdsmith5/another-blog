<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Script to build linear regression model for correction of PurpleAir measurements in Athens, GA</title><meta name="generator" content="MATLAB 9.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-01-16"><meta name="DC.source" content="Athens_PA_cal_project.m"><style type="text/css">

html { min-height:100%; margin-bottom:1px; }
html body td { vertical-align:top; text-align:left; }


a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Script to build linear regression model for correction of PurpleAir measurements in Athens, GA</h1><!--introduction--><p>This script starts with a timetable called "PA_TT_all" that contains PurpleAir sensor and regulatory instrument measurements of aerosol concentration in the Athens, GA area.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Split PA_TT up by sensor</a></li><li><a href="#2">Shift timezone to New York</a></li><li><a href="#3">Remove any rows with NaN</a></li><li><a href="#4">Remove any rows with bad A/B agreement</a></li><li><a href="#5">Split into training and test datasets</a></li><li><a href="#6">Train Linear Model</a></li><li><a href="#7">Compare to LRAPA Model</a></li><li><a href="#8">function to apply LRAPA correction to PA data</a></li></ul></div><h2 id="1">Split PA_TT up by sensor</h2><p>Re-cast timetable so that each row contains measurements from just a single PA sensor and the regulatory monitor</p><pre class="codeinput">PA_TT_new = timetable;
<span class="keyword">for</span> i = 1:2:width(PA_TT_all)-1
    temp_TT = PA_TT_all(:,[i,i+1,end]);
    temp_TT.Properties.VariableNames = {<span class="string">'A'</span>,<span class="string">'B'</span>,<span class="string">'PM_ref'</span>};
    PA_TT_new = [PA_TT_new; temp_TT];
<span class="keyword">end</span>
</pre><h2 id="2">Shift timezone to New York</h2><p>Timestamps shifted from UTC to Eastern ("New_York")</p><pre class="codeinput">PA_TT_new.Time.TimeZone = <span class="string">'Etc/UTC'</span>;
PA_TT_new.Time.TimeZone = <span class="string">'America/New_York'</span>;
</pre><h2 id="3">Remove any rows with NaN</h2><p>Remove samples with missing values</p><pre class="codeinput">PA_TT_new = rmmissing(PA_TT_new);
</pre><h2 id="4">Remove any rows with bad A/B agreement</h2><p>Each PA sensor contains two channels, "A" and "B". Use redundancy to identify suspect samples for which "A" and "B" disagree by more than 30%</p><pre class="codeinput">ratio = PA_TT_new.A ./ PA_TT_new.B;
flag = ratio &gt; 1.3 | ratio &lt; 1/1.3;
sum(flag);

PA_TT_new(flag,:) = [];
clearvars <span class="string">ratio</span> <span class="string">flag</span>;
</pre><h2 id="5">Split into training and test datasets</h2><p>Take cleaned data and split into training and test sets. Note that random partitioning into sets would not be a good idea because samples close in time can be correlated. Test: 1/1/21 - 8/31/21 Train: 9/1/21 - 10/31/21</p><pre class="codeinput">PA_TT_new.Time.TimeZone = <span class="string">''</span>;
flag = PA_TT_new.Time &gt; datetime(2020,12,31) &amp; PA_TT_new.Time &lt; datetime(2021,9,1);
PA_TT_train = timetable2table(PA_TT_new(flag,:),<span class="string">'ConvertRowTimes'</span>,false);
PA_TT_test = timetable2table(PA_TT_new(~flag,:),<span class="string">'ConvertRowTimes'</span>,false);

clearvars <span class="string">flag</span>;
</pre><h2 id="6">Train Linear Model</h2><p>Use 5-fold cross validation to assess model performance, both RMSE (root-mean square error) and MAE (mean absolute error). Also calculate RMSE and MAE for test ("predicted") data.</p><pre class="codeinput">CV = cvpartition(height(PA_TT_train),<span class="string">"KFold"</span>,5);

<span class="comment">% 5-fold cross validation</span>
CVMdl_linear = fitrlinear(PA_TT_train,<span class="string">'PM_ref'</span>,<span class="string">'CVPartition'</span>,CV,<span class="string">'Learner'</span>,<span class="string">'leastsquares'</span>);
RMSECV = sqrt(kfoldLoss(CVMdl_linear));
y_pred = kfoldPredict(CVMdl_linear);
MAE_CV = mean(abs(y_pred - PA_TT_train.PM_ref));

Mdl_linear = fitrlinear(PA_TT_train,<span class="string">'PM_ref'</span>,<span class="string">'Learner'</span>,<span class="string">'leastsquares'</span>);
y_pred = predict(Mdl_linear,PA_TT_test);
RMSEP = sqrt(sum((y_pred-PA_TT_test.PM_ref).^2)/height(y_pred));
MAE_P = mean(abs(y_pred - PA_TT_test.PM_ref));
</pre><h2 id="7">Compare to LRAPA Model</h2><p>Calculate same figures of merit as above for a commonly-used correction model, the "LRAPA" model: (<a href="https://www.lrapa.org/DocumentCenter/View/4147/PurpleAir-Correction-Summary">https://www.lrapa.org/DocumentCenter/View/4147/PurpleAir-Correction-Summary</a>).</p><pre class="codeinput">y_pred = LRAPA_correct(mean(PA_TT_train{:,1:2},2));
RMSECV(2) = sqrt(sum((y_pred-PA_TT_train.PM_ref).^2)/height(y_pred));
MAE_CV(2) = mean(abs(y_pred - PA_TT_train.PM_ref));

y_pred = LRAPA_correct(mean(PA_TT_test{:,1:2},2));
RMSEP(2) = sqrt(sum((y_pred-PA_TT_test.PM_ref).^2)/height(y_pred));
MAE_P(2) = mean(abs(y_pred - PA_TT_test.PM_ref));
</pre><h2 id="8">function to apply LRAPA correction to PA data</h2><p>uses PM2.5 from PA using CF=ATM as data_PA</p><pre class="codeinput"><span class="keyword">function</span> PA_LRAPA = LRAPA_correct(X)
    data_PA = X;
    PA_LRAPA = data_PA*0.5 - 0.66;
<span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2021b</a><br></p></div><!--
--></body></html>